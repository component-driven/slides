import CDTheme from "@component-driven/mdx-deck-theme";

export const theme = { ...CDTheme };

<Primary>

# The Good, The Bad, And The Ugly of Design Systems

</Primary>

---

## Andrey Okonetchnikov

UI engineer with experience in both design & development who specializes in interaction design, design systems and modern frontend development. Design System Lead @ Adverity

[@okonetchnikov](https://twitter.com/okonetchnikov)

---

## Adverity

1. Ex-FE developer (first introduction of React)
1. Design system guidance and consultant
1. Design system team lead

---

<Primary imgSrc="/assets/back-disassembled.jpg">

# Design Systems

</Primary>

---

> Design system defines a set of design-related rules as a system of instructions that can be re-used across single or multiple products

---

## Adverity Design System

- UI & UX consistency
- A common language
- Development speed
- Best practices

---

## Adverity Design System

1. 3 products depend on it
1. 30+ Frontend Engineers
1. 5+ UX Designers

---

<Figure
    src="/assets/ds-adoption.svg"
    alt="Design Systems Adoption"
    caption="Design System Adoption"
/>

---

<Secondary>

# Adoption problems

</Secondary>

---

## Adoption problems

1. Design system is the single source of failure. No QA tools, no tests, regressions happen in products.
2. No release process. Breaking changes can take days to upgrade.
3. Design is often out of sync with design system.
4. Lack of the documentation and guidelines. Developers don't know how use design system properly. Principles > Questions. This means, if I ever have a question, I'd need to establish a principle that answers / explains it.

---

## A single source of truth

---

## A single source of ~~truth~~ failure

---

## A single source of ~~truth~~ failure

1. No types, 100% JavaScript
1. Little to no component tests
1. CSS changes -> regressions in products
1. Hard to test changes manually

---

<TweetEmbed id="1381633331230601221" />

---

## Why invest into tests?

1. Quality of the product
1. Confidence in change
1. Speed of development

---

## What kind of tests?

1. Unit
1. Visual
1. Behavior

---

## Testing strategies

1. JavaScript -> TypeScript
1. Principles -> Unit tests
1. Visual regression tests
1. Behavior -> Model based tests
1. Manual QA

---

> Best tests are no tests

---

# JavaScript -> TypeScript

---

<Figure
    src={"/assets/js-ts.png"}
    alt="TypeScript migration epic"
    caption="TypeScript migration epic"
/>

---

## JavaScript -> TypeScript

1. Plan and dedicate time
1. Refactoring a JS file? Convert to TS first
1. JS -> TS _might be_ a breaking change

---

## Unit tests

1. Utility / Pure functions
1. General rules and principles

---

## General rules and principles

- Pass down valid HTML attributes to DOM
- Allow setting underlying HTML tag with `as`
- Merge `css`, `style`, and `className` props
- Always pass the `ref` with `forwardRef`
- Merge refs and event handlers

---

```javascript
describe('Ref Tests', () => {
    getComponents(components)
        .filter((component) => !excluded.includes(component.displayName))
        .forEach((Component) => {
            const ref = React.createRef()
            const { container } = render(<Component ref={ref} />)

            test(`${Component.displayName} ref is of "Element" instance`, () => {
                expect(ref.current).toBeInstanceOf(Element)
            })

            if (!excludedFromRootRefTestOnly.includes(Component.displayName)) {
                test(`${Component.displayName} ref goes to the root element`, () => {
                    expect(ref.current).toBe(container.firstChild)
                })
            }
        })
})
```

---

## Visual regressions

---

<Figure
    src={"/assets/doors.jpg"}
    alt="Different doors"
    caption="Visual regressions"
/>

---

<Figure
    src={"/assets/tests-visual-snapshot.png"}
    alt="Snapshot tests"
    caption="Snapshot tests"
/>

---

<Figure
    src={"/assets/tests-visual-snapshot-diff.png"}
    alt="Snapshots diff"
    caption="Snapshots diff"
/>

---

<Figure
    src={"/assets/tests-visual-snapshot-visual.png"}
    alt="Visual diff"
    caption="Visual diff"
/>

---

> Visual diff > Snapshot diff

---

<Figure
    src={"/assets/tests-visual-gh.png"}
    alt="Visual tests on GitHub"
    caption="Visual tests on GitHub"
/>

---

<Figure
    src={"/assets/chromatic-checks.png"}
    alt="GitHub PR checks"
    caption="Visual regressions checks in the PR"
/>

---

<Figure
    src={"/assets/chromatic-build.png"}
    alt="Chromatic Build"
    caption="Chromatic Build"
/>

---

<Figure
    src={"/assets/chromatic-ui.png"}
    alt="Chromatic UI Review"
    caption="Chromatic UI Review"
/>

---

## Challenges

1. How to ensure all possible states are covered?
1. How to test pseudo-states?
1. How to test interactive components?

---

<Figure
    src={"/assets/buttons-1.png"}
    alt="Possible states of a button"
    caption="Possible states of a button"
/>

---

<Figure
    src={"/assets/buttons-2.png"}
    alt="Possible states of a button"
    caption="Possible states of a button"
/>

---

<Figure
    src={"/assets/buttons-3.png"}
    alt="Possible states of a button"
    caption="Possible states of a button"
/>

---

<Figure
    src={"/assets/buttons-4.png"}
    alt="Possible states of a button"
    caption="Possible states of a button"
/>

---

## Revealing all possible states

---

<Demo src="https://johno.com/cartesian-product/" />

---

<Demo src="https://github.com/jondot/storybook-cartesian" />

---

<Demo src="https://ui.component-driven.dev/#/with-selector?id=withselector" />

---

## Interactivity & Behavior Tests

---

<Figure
    src={"/assets/tests-manual-how-to-test.png"}
    alt="Testing instructions"
    caption="Manual testing instructions"
/>

---

## Manual QA

1. Stash your local changes
1. Checkout the latest branch locally
1. Start the storybook and playroom
1. Follow instructions
1. Checkout your working branch
1. Unstash changes

---

<Figure
    src={"/assets/playroom-storybook-deployment-expanded.png"}
    alt="PR Deploy Preview"
    caption="PR Deploy Preview"
/>

---

## Manual QA

1. ~~Stash your local changes~~
1. ~~Checkout the latest branch locally~~
1. ~~Start the storybook and playroom~~
1. Follow instructions
1. ~~Checkout your working branch~~
1. ~~Unstash changes~~

---

<Figure
    src={"/assets/releases-checks-green.png"}
    alt="PR Status Checks"
    caption="PR Status Checks"
/>

---

<Figure
    src={"/assets/releases-update-branch.png"}
    alt="PR Status Checks"
    caption="PR Status Checks"
/>

---

# ðŸ¥º

---

# Release management

---

## Release management

1. **Versioning**
1. Automation

---

# **Sem**amtic **Ver**sioning

---

# **SemVer**

---

<Grid columns={3} gap={4}>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Major</Text>
        <Text>Breaking</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Minor</Text>
        <Text>New</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Patch</Text>
        <Text>Fix</Text>
    </Box>
</Grid>

---

<Grid columns={3} gap={4}>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Major</Text>
        <Text>Breaking</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Minor</Text>
        <Text>New</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Patch</Text>
        <Text>Fix</Text>
    </Box>
</Grid>

---

<Grid columns={3} gap={4}>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>0</Text>
        <Text style={{textDecoration: "line-through"}}>Major</Text>
        <Text>Breaking</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Minor</Text>
        <Text>New</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Patch</Text>
        <Text>Fix</Text>
    </Box>
</Grid>

---

<Grid columns={3} gap={4}>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Major</Text>
        <Text>Breaking</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Minor</Text>
        <Text>New</Text>
    </Box>
    <Box sx={{textAlign:"center"}}>
        <Text style={{fontSize: "5ch"}}>1</Text>
        <Text style={{textDecoration: "line-through"}}>Patch</Text>
        <Text>Fix</Text>
    </Box>
</Grid>

---

# Breaking changes

---

## Breaking changes

1. API changes
1. Removals (components or props)
1. Renames (component or props)

---

<Figure
    src={"/assets/chromatic-1.png"}
    alt="GitHub comments"
    caption="Is CSS change a breaking change?"
/>

---

## Is CSS change a breaking change?

---

# It depends!

---


> If developers might need to change their code, it's a breaking change

---

## How to find out if the code change is needed?

---

1. Visual regressions
1. Static analysis

---

## Visual regressions of applications

---

# ðŸ’¡ The idea

1. Checkout the main branch of the product
1. Inject current branch of the design system
1. Run visual regressions tests

---

<Figure
    src={"/assets/chromatic-build.png"}
    alt="Chromatic Build"
    caption="Chromatic Build"
/>

---

<Figure
    src={"/assets/chromatic-not-compatible.png"}
    alt="Major versions not compatible"
    caption="Major versions not compatible"
/>

---

## Problems

1. Only works if major version matches
1. Hard to implement
1. Missing current branches

---

# Static analysis

---

[![asciicast](https://asciinema.org/a/ymdY84Z9gmqoRl9afxCYZCSvY.svg)](https://asciinema.org/a/ymdY84Z9gmqoRl9afxCYZCSvY)

---

<Figure
    src={"/assets/static-analysis-usages.png"}
    alt="Usages of a component"
    caption="Usages of a design system component"
/>

---

## Insights

- What components should we move to TypeScript first?
- Can we deprecate a component?
- Should we change the default value of this prop?
- What's the risk of changing a component
- What is the adoption rate of the design system?

---

## Release management

1. Versioning
1. **Automation**

---

## Automatic migrations

---

### Replacing the Input

Introduce a new Input component but there are lots of usages of the old Input.

---

### Replacing the Input (design system)

1. Create a codemod to rename `Input` to `DeprecatedInput`
1. Create a new `Input` component
1. Introduce a breaking change

---

### Replacing the Input (consumers)

1. Upgrade to latest version
1. Run the codemod and create a PR
1. Start incrimentally adopt new Input

---

> Breaking change becomes an incrimental one

---

<Figure
    src={"/assets/static-analysis-deprecate.png"}
    alt="Deprecate codemod"
    caption="Deprecate codemod"
/>

---

<Primary>

# Recap

</Primary>

---



---

## Links and credits

- [Cartesian products](https://johno.com/cartesian-product/)
- [Visualizing Pseudo-states](https://ui.component-driven.dev/#/with-selector)
- [JSCodeshift](https://github.com/facebook/jscodeshift)
- [MonoLisa Coding Font](https://www.monolisa.dev)

---

<Figure
  src={"/assets/component-driven.svg"}
  alt="Component-driven Logo"
  caption={
    <a href="https://www.component-driven.dev">www.component-driven.dev</a>
  }
/>

---

<Primary>

# Thank you!

<Grid gridGap={[3, 5]} columns={[1, 2]} pt={4}>
  <a href="https://twitter.com/okonetchnikov">@okonetchnikov</a>
  <a href="https://twitter.com/ComponentDriven">@ComponentDriven</a>
</Grid>

</Primary>
